<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Suwahas Sathsara</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ADMIN THEME --- */
        :root {
            --primary: #00f2ff;
            --secondary: #0051ff;
            --danger: #ff4d4d;
            --success: #00ff88;
            --bg-dark: #050b14;
            --card-bg: rgba(10, 20, 35, 0.95);
            --border: rgba(0, 242, 255, 0.3);
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
        }

        * { box-sizing: border-box; }
        
        body { 
            margin: 0; padding: 0; 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-dark);
            background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* Navbar */
        .admin-nav {
            background: rgba(5, 11, 20, 0.9);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px);
        }
        .nav-brand { font-family: 'Rajdhani', sans-serif; font-size: 20px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .logout-btn { background: rgba(255, 77, 77, 0.15); border: 1px solid var(--danger); color: var(--danger); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s; }
        .logout-btn:hover { background: var(--danger); color: white; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); }
        .stat-value { font-family: 'Rajdhani', sans-serif; font-size: 32px; font-weight: 700; color: var(--text-main); }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* Controls */
        .controls-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; }
        .search-input { width: 100%; padding: 12px 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 6px; color: white; outline: none; font-family: 'Rajdhani', sans-serif; }
        
        .btn-control { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; color: white; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-refresh { background: var(--secondary); }
        .btn-add { background: var(--success); color: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }
        .btn-add:hover { background: #00e67a; }

        /* Table */
        .user-table-container { background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: top; }
        th { background: rgba(0, 242, 255, 0.1); color: var(--primary); font-family: 'Rajdhani', sans-serif; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; }
        td { font-size: 13px; color: #ddd; }
        
        /* Device IDs in Table */
        .table-dev-list { display: flex; flex-direction: column; gap: 4px; }
        .table-dev-chip { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: var(--primary); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 10px; 
            font-family: monospace;
            width: fit-content;
        }

        .badge-new { background: linear-gradient(90deg, #ff00cc, #333399); color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 5px; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-active { background: rgba(0, 255, 136, 0.15); color: var(--success); border: 1px solid var(--success); }
        .badge-expired { background: rgba(255, 77, 77, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        
        .btn-action { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; transition: 0.2s; }
        .btn-edit { background: var(--secondary); color: white; }
        .btn-delete { background: rgba(255,0,0,0.2); color: var(--danger); border: 1px solid var(--danger); }

        /* Chips */
        .device-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; margin-bottom: 10px; max-height: 100px; overflow-y: auto; }
        .device-chip { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 11px; display: flex; align-items: center; gap: 5px; color: white; }
        .btn-remove-dev { cursor: pointer; color: var(--danger); font-weight: bold; }
        .add-device-box { display: flex; gap: 5px; margin-bottom: 15px; }
        .add-device-box input { flex: 1; }
        .btn-mini-add { background: var(--success); border: none; padding: 0 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: #0b111a; border: 1px solid var(--primary); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 0 40px rgba(0, 242, 255, 0.2); animation: fadeIn 0.3s; }
        .modal-title { color: var(--primary); font-family: 'Rajdhani', sans-serif; font-size: 22px; margin-bottom: 20px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        .modal-input { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 5px; outline: none; font-family: 'Poppins', sans-serif; }
        .modal-input:focus { border-color: var(--primary); }
        /* Style specifically for Date-Time input */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 10px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .btn-close { margin-top: 10px; width: 100%; background: transparent; color: #777; border: none; cursor: pointer; font-size: 12px; }

        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid rgba(0, 242, 255, 0.1); margin-bottom: 15px; border-radius: 8px; background: rgba(255,255,255,0.02); }
            td { border: none; position: relative; padding-left: 50%; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.02); }
            td:before { position: absolute; top: 15px; left: 15px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--text-muted); content: attr(data-label); }
            .table-dev-list { align-items: flex-end; }
        }

        #adminLogin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { text-align: center; width: 90%; max-width: 350px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="adminLogin">
        <div class="login-box">
            <h2 style="color: var(--primary); font-family: 'Rajdhani', sans-serif;">ADMIN ACCESS</h2>
            <div class="form-group">
                <input type="email" id="adminEmail" class="modal-input" placeholder="Admin Email" style="text-align: center;">
            </div>
            <div class="form-group">
                <input type="password" id="adminPass" class="modal-input" placeholder="Password" style="text-align: center;">
            </div>
            <button class="btn-save" onclick="adminLogin()">SECURE LOGIN</button>
            <p id="loginMsg" style="color: var(--danger); font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <nav class="admin-nav">
        <div class="nav-brand"><i class="fa-solid fa-shield-cat"></i> SIGNAL ADMIN</div>
        <button class="logout-btn" onclick="logout()">LOGOUT</button>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeUsers" style="color: var(--success)">0</div>
                <div class="stat-label">Active Subscriptions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="expiredUsers" style="color: var(--danger)">0</div>
                <div class="stat-label">Expired Accounts</div>
            </div>
        </div>

        <div class="controls-bar">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by Email..." onkeyup="filterUsers()">
            </div>
            <button class="btn-control btn-add" onclick="openAddModal()">
                <i class="fa-solid fa-user-plus"></i> NEW USER
            </button>
            <button class="btn-control btn-refresh" onclick="location.reload()">
                <i class="fa-solid fa-sync"></i>
            </button>
        </div>

        <div class="user-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Email / User</th>
                        <th>Created Date</th>
                        <th>Expiry Date & Time</th>
                        <th width="30%">Device IDs</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="5" style="text-align: center;">Loading Data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">MANAGE ACCESS</div>
            <input type="hidden" id="editUid">
            <div class="form-group">
                <label>User Email</label>
                <input type="text" id="editEmail" class="modal-input" readonly style="color: #777;">
            </div>
            <div class="form-group">
                <label>Set Expiry Date & Time</label>
                <input type="datetime-local" id="editDate" class="modal-input">
            </div>
            <div class="form-group">
                <label>Manage Devices (Add ID)</label>
                <div class="add-device-box">
                    <input type="text" id="newDeviceInput" class="modal-input" placeholder="Paste ID (e.g. DEV-X9...)">
                    <button class="btn-mini-add" onclick="addNewDeviceID()"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="deviceListContainer" class="device-list"></div>
            </div>
            <button class="btn-save" onclick="saveUserChanges()">UPDATE ALL CHANGES</button>
            <button class="btn-close" onclick="closeModal('editModal')">CANCEL</button>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" style="color: var(--success);">CREATE NEW USER</div>
            <div class="form-group">
                <label>New Email</label>
                <input type="email" id="newEmail" class="modal-input" placeholder="client@email.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="text" id="newPass" class="modal-input" placeholder="Password123">
            </div>
            <div class="form-group">
                <label>Expiry Date & Time</label>
                <input type="datetime-local" id="newDate" class="modal-input">
            </div>
            <button class="btn-save" id="btnCreate" onclick="createNewUser()" style="background: var(--success);">CREATE ACCOUNT</button>
            <button class="btn-close" onclick="closeModal('addUserModal')">CANCEL</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBmLvGb0vXkJhKVKew1sYZpHuVPo-mHvjk",
          authDomain: "aviatorsignal-ff90c.firebaseapp.com",
          projectId: "aviatorsignal-ff90c",
          storageBucket: "aviatorsignal-ff90c.firebasestorage.app",
          messagingSenderId: "656549146292",
          appId: "1:656549146292:web:f35944e4ae7b6db943f1e1",
          measurementId: "G-B5N5DG523J"
        };

        const primaryApp = firebase.initializeApp(firebaseConfig);
        const auth = primaryApp.auth();
        const db = primaryApp.firestore();

        // Admin Email Lock (Same as before)
        const ALLOWED_ADMIN_EMAIL = "suwahassathsara2006@gmail.com";

        let allUsers = [];
        let currentEditingDevices = []; 

        function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const pass = document.getElementById('adminPass').value.trim();
            const msg = document.getElementById('loginMsg');

            if(!email || !pass) { msg.innerText = "Please enter credentials"; return; }

            // Security Check
            if(email !== ALLOWED_ADMIN_EMAIL) {
                msg.innerText = "ACCESS DENIED: You are not the Admin!";
                return;
            }

            msg.innerText = "Verifying with Server...";

            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    return auth.signInWithEmailAndPassword(email, pass);
                })
                .then(() => {
                    document.getElementById('adminLogin').style.display = 'none';
                    loadUsers();
                })
                .catch((err) => { 
                    msg.innerText = "Login Failed: " + err.message; 
                });
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                if(user.email === ALLOWED_ADMIN_EMAIL) {
                    document.getElementById('adminLogin').style.display = 'none';
                    loadUsers();
                } else {
                    auth.signOut();
                    document.getElementById('adminLogin').style.display = 'flex';
                }
            } else {
                document.getElementById('adminLogin').style.display = 'flex';
            }
        });

        function logout() { auth.signOut(); window.location.reload(); }

        function loadUsers() {
            db.collection("users").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
                allUsers = [];
                let activeCount = 0, expiredCount = 0;
                let today = new Date();

                snapshot.forEach((doc) => {
                    let data = doc.data();
                    let isExpired = false;
                    
                    // Check Expiry (Time aware)
                    if (data.expiryDate) {
                        let exp = new Date(data.expiryDate);
                        if(exp < today) {
                            isExpired = true; expiredCount++;
                        } else {
                            activeCount++;
                        }
                    } else {
                        // Lifetime
                        activeCount++;
                    }

                    let deviceList = [];
                    if (data.allowed_devices && Array.isArray(data.allowed_devices)) {
                        deviceList = data.allowed_devices;
                    } else if (data.device_id) {
                        deviceList = [data.device_id]; 
                    }
                    
                    let createdStr = data.createdAt ? data.createdAt.split('T')[0] : "Unknown";

                    allUsers.push({
                        uid: doc.id,
                        email: data.email || "No Email",
                        createdAt: createdStr,
                        expiryDate: data.expiryDate || "",
                        devices: deviceList,
                        isExpired: isExpired
                    });
                });

                document.getElementById('totalUsers').innerText = allUsers.length;
                document.getElementById('activeUsers').innerText = activeCount;
                document.getElementById('expiredUsers').innerText = expiredCount;
                renderTable(allUsers);
            });
        }

        function renderTable(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            if(users.length === 0) { tbody.innerHTML = '<tr><td colspan="5" align="center">No Users Found</td></tr>'; return; }

            let todayStr = new Date().toISOString().split('T')[0];

            users.forEach((user, index) => {
                let badge = user.isExpired ? `<span class="badge badge-expired">EXPIRED</span>` : `<span class="badge badge-active">ACTIVE</span>`;
                let expiryDisplay = user.expiryDate;

                if(!user.expiryDate) {
                    badge = `<span class="badge badge-active" style="background:#0051ff20; color:#00f2ff;">LIFETIME</span>`;
                    expiryDisplay = "Lifetime";
                } else {
                    // Format the date for display (Replace T with space)
                    expiryDisplay = user.expiryDate.replace("T", " ");
                }

                let createdDisplay = user.createdAt;
                if(user.createdAt === todayStr) {
                    createdDisplay += ` <span class="badge-new">NEW</span>`;
                }

                let devicesHtml = "";
                if(user.devices.length > 0) {
                    devicesHtml = '<div class="table-dev-list">';
                    user.devices.forEach(dev => {
                        devicesHtml += `<span class="table-dev-chip">${dev}</span>`;
                    });
                    devicesHtml += '</div>';
                } else {
                    devicesHtml = '<span style="opacity:0.5; font-size:11px;">No Devices</span>';
                }

                tbody.innerHTML += `
                    <tr>
                        <td data-label="User">${user.email}</td>
                        <td data-label="Created">${createdDisplay}</td>
                        <td data-label="Expiry">${expiryDisplay}</td>
                        <td data-label="Device IDs">${devicesHtml}</td>
                        <td data-label="Actions">
                            <button class="btn-action btn-edit" onclick="openEdit(${index})"><i class="fa-solid fa-pen"></i> EDIT</button>
                            <button class="btn-action btn-delete" onclick="deleteUser('${user.uid}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function filterUsers() {
            let val = document.getElementById('searchInput').value.toLowerCase();
            renderTable(allUsers.filter(u => u.email.toLowerCase().includes(val)));
        }

        function openEdit(index) {
            let user = allUsers[index];
            document.getElementById('editUid').value = user.uid;
            document.getElementById('editEmail').value = user.email;
            
            // Format existing date for datetime-local input (needs YYYY-MM-DDTHH:MM)
            // If user.expiryDate is stored as ISO string, it works nicely if we trim seconds/milliseconds
            if(user.expiryDate) {
                // Assuming stored format is ISO string or close to it
                // We take the first 16 chars: "2023-12-31T15:30"
                document.getElementById('editDate').value = user.expiryDate.substring(0, 16);
            } else {
                document.getElementById('editDate').value = "";
            }
            
            currentEditingDevices = [...user.devices]; 
            renderDeviceManager();
            document.getElementById('editModal').style.display = 'flex';
        }

        function renderDeviceManager() {
            const container = document.getElementById('deviceListContainer');
            container.innerHTML = '';
            currentEditingDevices.forEach((dev, idx) => {
                container.innerHTML += `
                    <div class="device-chip">
                        ${dev} 
                        <span class="btn-remove-dev" onclick="removeDeviceFromList(${idx})">&times;</span>
                    </div>`;
            });
        }

        function addNewDeviceID() {
            const input = document.getElementById('newDeviceInput');
            const newId = input.value.trim();
            if(newId) {
                if(!currentEditingDevices.includes(newId)) {
                    currentEditingDevices.push(newId);
                    renderDeviceManager();
                    input.value = '';
                } else {
                    alert("This Device ID is already added!");
                }
            }
        }

        function removeDeviceFromList(idx) {
            currentEditingDevices.splice(idx, 1);
            renderDeviceManager();
        }

        function saveUserChanges() {
            let uid = document.getElementById('editUid').value;
            let date = document.getElementById('editDate').value; // Returns ISO-like string: 2023-10-27T15:30
            
            db.collection("users").doc(uid).update({ 
                expiryDate: date,
                allowed_devices: currentEditingDevices 
            }).then(() => {
                closeModal('editModal');
                alert("User Updated Successfully!");
            });
        }

        function openAddModal() {
            document.getElementById('newEmail').value = "";
            document.getElementById('newPass').value = "";
            document.getElementById('newDate').value = "";
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function createNewUser() {
            const email = document.getElementById('newEmail').value;
            const pass = document.getElementById('newPass').value;
            const date = document.getElementById('newDate').value; // Returns ISO-like string
            const btn = document.getElementById('btnCreate');

            if(!email || !pass || !date) { alert("Please fill all fields!"); return; }
            btn.innerText = "CREATING...";
            
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            secondaryApp.auth().createUserWithEmailAndPassword(email, pass)
                .then((cred) => {
                    return db.collection("users").doc(cred.user.uid).set({
                        email: email,
                        expiryDate: date,
                        createdAt: new Date().toISOString(),
                        allowed_devices: [] 
                    });
                })
                .then(() => {
                    alert("User Created Successfully!");
                    closeModal('addUserModal');
                    secondaryApp.delete(); 
                })
                .catch((error) => {
                    alert("Error: " + error.message);
                })
                .finally(() => {
                    btn.innerText = "CREATE ACCOUNT";
                });
        }

        function deleteUser(uid) {
            if(confirm("Delete this user data? (Cannot undo)")) {
                db.collection("users").doc(uid).delete();
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
